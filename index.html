<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CANADA</title>
    <!-- Tải Tailwind CSS để làm giao diện -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải font Montserrat từ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Montserrat', sans-serif; background-color: #f0f2f5; }
        
        #cover-container { height: 100vh; color: white; }
        .cover-image {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 2s ease-in-out;
        }
        .text-shadow { text-shadow: 0 2px 8px rgba(0, 0, 0, 0.7); }
        .masonry-container {
            column-gap: 1rem;
            padding: 1rem;
            column-count: 2; 
        }
        .masonry-item {
            display: inline-block;
            width: 100%;
            margin-bottom: 1rem;
            break-inside: avoid;
        }
        .masonry-item img {
            width: 100%;
            height: auto;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer; 
        }
        .masonry-item img:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        @media (min-width: 768px) { .masonry-container { column-count: 3; column-gap: 1.25rem; } }
        @media (min-width: 1024px) { .masonry-container { column-count: 4; } }
        
        #lightbox.hidden { display: none; }
    </style>
</head>
<body class="bg-white">

    <!-- PHẦN 1: ẢNH BÌA LỚN -->
    <header id="cover-container" class="relative">
        <div id="cover-bg-1" class="absolute inset-0 cover-image" style="background-image: url('');"></div>
        <div id="cover-bg-2" class="absolute inset-0 cover-image opacity-0" style="background-image: url('');"></div>
        
        <div class="relative z-10 h-full flex flex-col items-center justify-center text-shadow">
            <div class="text-center">
                <h1 class="text-5xl md:text-7xl font-bold">CANADA</h1>
                <p class="text-lg md:text-2xl mt-4"></p>
            </div>
            <a href="#main-content" class="absolute bottom-10 left-1/2 -translate-x-1/2 animate-bounce p-2 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
            </a>
        </div>
    </header>

    <!-- PHẦN 2: TIÊU ĐỀ VÀ MÔ TẢ ALBUM -->
    <main id="main-content" class="container mx-auto px-4 py-12">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-gray-800">huyhung</h2>
            <p class="mt-2 text-gray-600 max-w-2xl mx-auto">4 mois à l'UQTR</p>
        </div>

        <div id="gallery-container" class="masonry-container">
            <div id="loading-indicator" class="text-center col-span-full">
                <p class="text-gray-600">Đang tải ảnh từ Google Drive...</p>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white text-center p-6 mt-8">
        <p>&copy; 2025 Trần Huy Hùng</p>
    </footer>

    <!-- PHẦN 5: LIGHTBOX NÂNG CẤP VỚI TÍNH NĂNG BÌNH LUẬN -->
    <div id="lightbox" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
        <div class="relative bg-white rounded-lg shadow-lg w-full max-w-4xl max-h-[95vh] flex flex-col">
            <span id="close-lightbox" class="absolute -top-2 -right-2 text-white text-3xl font-bold cursor-pointer hover:text-gray-300 z-20 bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center">&times;</span>
            
            <div class="flex-grow overflow-y-auto">
                <img id="lightbox-image" src="" alt="Ảnh phóng to" class="w-full h-auto object-contain">
                
                <div id="comment-section" class="p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Bình luận</h3>
                    <div id="comment-display" class="space-y-4 mb-6">
                        <!-- Bình luận sẽ được tải vào đây -->
                    </div>
                    
                    <form id="comment-form">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2">Để lại bình luận</h4>
                        <input id="comment-name" type="text" placeholder="Tên của bạn" class="w-full p-2 mb-2 rounded border bg-gray-50 text-gray-800 border-gray-300" required>
                        <textarea id="comment-text" placeholder="Nội dung bình luận..." rows="3" class="w-full p-2 mb-2 rounded border bg-gray-50 text-gray-800 border-gray-300" required></textarea>
                        <button type="submit" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">Gửi bình luận</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== PHẦN SCRIPT TỰ ĐỘNG LẤY ẢNH VÀ XỬ LÝ TÍNH NĂNG MỚI ===== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const DRIVE_API_KEY = 'AIzaSyD2ZqR4YO0QIWf_4h2idDX1_ohkW2TwGi0'; 
        const FOLDER_ID = '1Ag43jZQLTNs0ShmzWWveU82DUYVaBNPp';
        
        const galleryContainer = document.getElementById('gallery-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const coverBg1 = document.getElementById('cover-bg-1');
        const coverBg2 = document.getElementById('cover-bg-2');
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const closeLightboxBtn = document.getElementById('close-lightbox');
        const commentDisplay = document.getElementById('comment-display');
        const commentForm = document.getElementById('comment-form');
        const commentSection = document.getElementById('comment-section');

        let db, auth;
        let firebaseReady = false;
        let imageList = [];
        let isCover1Active = true;
        let currentImageId = null;
        let unsubscribeComments = null;

        async function initializeFirebase() {
            // SỬA LỖI: Kiểm tra xem biến cấu hình có tồn tại không.
            if (typeof __firebase_config === 'undefined' || !__firebase_config) {
                console.log("Không tìm thấy cấu hình Firebase. Tính năng bình luận sẽ bị tắt.");
                if (commentSection) commentSection.style.display = 'none'; // Ẩn hoàn toàn khu vực bình luận
                firebaseReady = false;
                return; // Dừng hàm tại đây
            }

            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (!firebaseConfig.apiKey) {
                    throw new Error("Cấu hình Firebase không hợp lệ hoặc thiếu API Key.");
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await setupAuth();
                firebaseReady = true;
                console.log("Firebase đã khởi tạo thành công!");

            } catch (error) {
                console.error("Lỗi khởi tạo Firebase:", error);
                firebaseReady = false;
                if(commentSection) {
                     commentSection.innerHTML = `<p class="text-red-500 italic p-4 text-center">Lỗi: Không thể tải hệ thống bình luận do cấu hình sai.</p>`;
                }
            }
        }

        async function setupAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Lỗi xác thực Firebase:", error);
                firebaseReady = false;
            }
        }

        function openLightbox(imageUrl, imageId) {
            currentImageId = imageId;
            lightboxImage.src = imageUrl;
            lightbox.classList.remove('hidden');
            if (firebaseReady) {
                loadComments(imageId);
            }
        }

        function closeLightbox() {
            if (unsubscribeComments) unsubscribeComments();
            lightbox.classList.add('hidden');
            commentDisplay.innerHTML = '';
            currentImageId = null;
        }

        function loadComments(imageId) {
            if (!firebaseReady) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const commentsCollection = collection(db, `/artifacts/${appId}/public/data/comments`);
            const q = query(commentsCollection, where("imageId", "==", imageId));

            unsubscribeComments = onSnapshot(q, (querySnapshot) => {
                commentDisplay.innerHTML = '';
                if (querySnapshot.empty) {
                    commentDisplay.innerHTML = '<p class="text-gray-500">Chưa có bình luận nào. Hãy là người đầu tiên!</p>';
                    return;
                }
                const comments = [];
                querySnapshot.forEach((doc) => comments.push(doc.data()));
                comments.sort((a, b) => a.timestamp?.toMillis() - b.timestamp?.toMillis());
                
                comments.forEach(commentData => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'p-3 bg-gray-100 rounded-lg';
                    commentEl.innerHTML = `
                        <p class="font-bold text-gray-800">${commentData.name || 'Anonym'}</p>
                        <p class="text-gray-600">${commentData.text}</p>
                    `;
                    commentDisplay.appendChild(commentEl);
                });
            }, (error) => {
                console.error("Lỗi khi tải bình luận:", error);
                commentDisplay.innerHTML = '<p class="text-red-500">Lỗi: Không thể tải bình luận.</p>';
            });
        }

        async function addComment(imageId, name, text) {
            if (!firebaseReady) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                const commentsCollection = collection(db, `/artifacts/${appId}/public/data/comments`);
                await addDoc(commentsCollection, { imageId, name, text, timestamp: serverTimestamp() });
            } catch (error) {
                console.error("Lỗi khi thêm bình luận:", error);
            }
        }

        function startCoverSlideshow() {
            if (imageList.length > 1) {
                if(coverBg1) coverBg1.style.backgroundImage = `url('${imageList[0].url}')`;
                setInterval(() => {
                    const randomIndex = Math.floor(Math.random() * imageList.length);
                    const newImageUrl = imageList[randomIndex].url;
                    if (isCover1Active) {
                        coverBg2.style.backgroundImage = `url('${newImageUrl}')`;
                        coverBg2.style.opacity = 1;
                        coverBg1.style.opacity = 0;
                    } else {
                        coverBg1.style.backgroundImage = `url('${newImageUrl}')`;
                        coverBg1.style.opacity = 1;
                        coverBg2.style.opacity = 0;
                    }
                    isCover1Active = !isCover1Active;
                }, 5000); 
            } else if (imageList.length === 1) {
                if(coverBg1) coverBg1.style.backgroundImage = `url('${imageList[0].url}')`;
            }
        }

        async function fetchImages() {
            const apiUrl = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+(mimeType='image/jpeg'+or+mimeType='image/png')&key=${DRIVE_API_KEY}&fields=files(id,name)`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData?.error?.message || `Lỗi HTTP: ${response.status}`;
                    throw new Error(errorMessage);
                }
                const data = await response.json();
                if (loadingIndicator) loadingIndicator.remove();
                if (data.files && data.files.length > 0) {
                    imageList = data.files.map(file => ({
                        id: file.id,
                        url: `https://drive.google.com/thumbnail?id=${file.id}&sz=w2048`
                    }));
                    imageList.forEach(imageData => {
                        const masonryItem = document.createElement('div');
                        masonryItem.className = 'masonry-item';
                        const img = document.createElement('img');
                        img.src = imageData.url;
                        img.alt = 'Ảnh từ Google Drive';
                        img.loading = 'lazy';
                        img.addEventListener('click', () => openLightbox(imageData.url, imageData.id));
                        masonryItem.appendChild(img);
                        galleryContainer.appendChild(masonryItem);
                    });
                    startCoverSlideshow();
                } else {
                     galleryContainer.innerHTML = '<p class="text-center col-span-full">Không tìm thấy ảnh nào trong thư mục.</p>';
                }
            } catch (error) {
                console.error('Lỗi khi tải ảnh:', error);
                if(galleryContainer) galleryContainer.innerHTML = `<p class="text-red-600 font-bold text-center col-span-full">Không thể tải ảnh. Chi tiết: ${error.message}</p>`;
            }
        }

        closeLightboxBtn.addEventListener('click', closeLightbox);
        lightbox.addEventListener('click', (e) => {
            if (e.target.id === 'lightbox') closeLightbox();
        });

        commentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!firebaseReady) {
                alert("Tính năng bình luận hiện không khả dụng.");
                return;
            }
            const nameInput = document.getElementById('comment-name');
            const textInput = document.getElementById('comment-text');
            if (currentImageId && nameInput.value && textInput.value) {
                addComment(currentImageId, nameInput.value, textInput.value);
                textInput.value = '';
            }
        });
        
        // --- CHẠY ỨNG DỤNG ---
        await initializeFirebase();
        await fetchImages();
    </script>
</body>
</html>

